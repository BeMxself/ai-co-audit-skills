# AI 实现审计工作流

本目录提供一个基于 Shell 的自动化“实现审计”流程，由 `claude` 和 `codex` 协同迭代，收敛出最终审计报告。

## 脚本说明

- `automation/implementation-audit/init.sh`：在 `.ai-workflows/<task-id>/` 下初始化实现审计任务
- `automation/implementation-audit/run-implementation-audit.sh`：共享执行编排脚本
- `automation/implementation-audit/lib/common.sh`：公共工具（日志、JSON、转录、状态）
- `automation/implementation-audit/lib/runner.sh`：AI 命令执行封装

## 快速开始

1. 初始化任务（极简）：

```bash
bash automation/implementation-audit/init.sh \
  --input docs/plans/2026-02-11-security-external-auth-design.md
```

说明：
- 只需提供 `--input`（可重复传多个）。
- `--prompt` 可选；不传则使用默认审计目标。
- `task-id`、`task-name`、`report-base-name` 自动生成（优先尝试 claude，失败自动回退本地生成）。

2. 初始化任务（可选自定义提示词）：

```bash
bash automation/implementation-audit/init.sh \
  --input docs/plans/2026-02-11-security-external-auth-design.md \
  --input docs/plans/2026-02-23-security-external-auth-implementation-audit.md \
  --prompt "重点检查未完成项、设计偏差、重复实现、逻辑冲突，并按严重级排序"
```

如果希望流程结束后把最终合并报告额外落到指定位置（相对 `workingDirectory`），在初始化时传入 `--final-report-path`。该路径会写入任务的 `run/continue` 脚本参数，不会落到任务配置文件中：

```bash
bash automation/implementation-audit/init.sh \
  --input docs/plans/2026-02-11-security-external-auth-design.md \
  --final-report-path docs/reports/external-auth-final-audit.md
```

3. 执行任务：

```bash
./.ai-workflows/<auto-generated-task-id>/run
```

说明：
- `run` 启动后会先读取配置并输出插件版本号。
- 如果当前是交互终端，会提示确认：输入 `y` 继续，其他输入则终止。
- 如果不是交互终端（例如 CI / 重定向执行），会自动放行继续执行。
- Claude debug 日志默认关闭（避免海量噪声）；排障时可临时开启：
  `IMPLEMENTATION_AUDIT_CLAUDE_DEBUG=1 ./.ai-workflows/<auto-generated-task-id>/run`

注意：`run` / `continue` 会调用 `claude` CLI，无法在 Claude Code 会话内嵌套执行。请在独立终端运行，或在 Claude Code 中使用 `--dry-run` 仅生成 prompts。

4. 干跑（不调用 AI）：

```bash
./.ai-workflows/<auto-generated-task-id>/run --dry-run
```

5. 断点恢复（失败后续跑）：

```bash
./.ai-workflows/<auto-generated-task-id>/continue
```

6. 手工指定恢复阶段（人工纠偏）：

```bash
./.ai-workflows/<auto-generated-task-id>/continue --from-phase round-codex --from-round 3
```

## 流程阶段

1. 初始审计：
- `claude` 和 `codex` 使用同一提示词，分别输出两份报告（并行执行）。
2. 交叉对比：
- `claude` 和 `codex` 分别对两份初始报告做对比分析。
3. 合并报告：
- `claude` 基于两份报告和两份对比分析生成合并版报告。
4. 迭代循环：
- `codex` 评审合并版报告。
- 若输出包含成功标记串，则退出循环。
- 否则将评审意见交给 `claude` 修订。
- 若 `claude` 输出包含成功标记串（即本轮意见全部不采纳），则退出循环。
- 否则用修订版覆盖合并报告，进入下一轮。
- 达到 `maxRounds`（默认 `15`）后停止。

默认成功标记串：

```text
当前版本已无问题，可以作为正式版本使用
```

## 任务目录结构

```text
.ai-workflows/<task-id>/
  config/task.json
  inputs/
    objective.txt
    targets.txt
  prompts/
  reports/
    initial/
    comparison/
    merged/
    rounds/
  logs/
  state/progress.json
  state/state.json
  transcripts/implementation-audit-dialogue.md
  run
  continue
  README.md
```

## 配置文件（`config/task.json`）

必填字段：
- `taskName`
- `objective`
- `inputs`（数组，至少 1 项）
- `reportBaseName`
- `maxRounds`

可选字段：
- `timeoutSeconds`（默认 `7200`）
- `workingDirectory`（默认 `.`）
- `finalReportPath`（相对 `workingDirectory` 的输出路径；为避免泄露给 agent，默认不写入任务配置，而是写入 `run/continue` 参数）
- `successMarker`（默认使用上面的成功标记串）
- `agents.claude.command`（自定义命令，从 stdin 读取提示词）
- `agents.codex.command`（自定义命令，从 stdin 读取提示词）

## 运行参数

`run-implementation-audit.sh` 支持：

- `--task-dir <dir>` 必填
- `--config <file>`
- `--max-rounds <n>`
- `--timeout-seconds <n>`
- `--final-report-path <relative-path>`
- `--resume`
- `--from-phase <phase>`（需和 `--resume` 一起使用）
- `--from-round <n>`（仅 `round-codex/round-claude` 阶段可用）
- `--dry-run`

## 断点恢复机制

- 每完成一个阶段，都会写入 `state/progress.json` 检查点（`nextPhase`、`nextRound`、`lastStep`、`finalStatus`）。
- `run` 会从头执行并重建转录头信息；`continue` 会以 `--resume` 模式读取检查点继续执行。
- 如果中断发生在某个阶段执行中，则检查点停留在“上一已完成阶段”，恢复后会重跑该未完成阶段，避免跳过。
- 当流程完成（包括成功收敛或达到轮次上限）时，`progress.json` 的 `nextPhase` 会变为 `completed`，并写入 `state/state.json` 作为最终结果。
- `continue --from-phase` 可强制覆盖检查点继续执行，可选阶段：
  `initial-claude`、`initial-codex`、`compare-claude`、`compare-codex`、`merge-claude`、`round-codex`、`round-claude`、`completed`。

## 说明

- 该流程使用独立命名空间 `automation/implementation-audit/`，不会修改现有 GDIM 脚本。
- 最终状态写入 `state/state.json`。
- 审计过程会生成对话式转录文件：`transcripts/implementation-audit-dialogue.md`，便于人工复核。
- 如果你希望强制不用 claude 生成元信息，可在初始化时加 `--no-claude-meta`。
- 运行日志会显示当前阶段与迭代轮次，便于跟踪进度。
- compare/merge/迭代阶段的 prompts 默认只提供文件相对路径，不再内联整段文件内容，以便 agent 按需读取并利用其内部读取优化。
- 运行中按 `Ctrl+C` 会立即中断当前流程，并终止正在执行的并行初始分析子任务。
- `sync-automation.sh` 会在 reference 指向 `~/.claude/plugins/cache` 时自动解析到非缓存源目录（优先 `AI_CO_AUDIT_SKILLS_SOURCE_DIR`，其次常见本地仓库路径）；若找不到有效源会报错并提示设置 `AI_CO_AUDIT_SKILLS_SOURCE_DIR`。
